import{Color,PointsMaterial,MeshLambertMaterial,SphereGeometry,LineDashedMaterial,VertexColors,LineBasicMaterial,Scene,Object3D,PerspectiveCamera,SpotLight,WebGLRenderer,Mesh,Line,Vector3,Geometry,LineStrip,Points,AxisHelper,MeshBasicMaterial}from"../../vendor/three.min.js";let handlerRegistry=new WeakMap;class Observer{constructor(){handlerRegistry.set(this,new Map)}static on(...e){return Observer.prototype.on.apply(Observer,e)}static off(...e){return Observer.prototype.off.apply(Observer,e)}static trigger(...e){return Observer.prototype.trigger.apply(Observer,e)}on(e,t){let r=handlerRegistry.get(this);r.has(e)||r.set(e,[]),r.get(e).push(t)}off(e,t){let r=handlerRegistry.get(this);if(r.has(e))if(t){let a=r.get(e),s=a.indexOf(t);s>-1&&(a.splice(s,1),0===a.length&&r.delete(e))}else r.get(e).length=0,r.delete(e)}trigger(e,...t){let r=handlerRegistry.get(this);if(r.has(e))for(let a of r.get(e))a.apply(null,t)}}handlerRegistry.set(Observer,new Map);let actionStore=new Map,app=Object.assign(new Observer,{addAction(e,t){actionStore.set(e,t)},execAction(e,...t){if(!this.actionEnabled(e))throw new Error(`Action "${e}" is disabled and can't be executed`);return actionStore.get(e).exec(...t)},actionEnabled(e){return!this.busy&&actionStore.get(e).enabled},getActionStates(){let e=this.busy,t=new Map;for(let[r,a]of actionStore)t.set(r,!e&&a.enabled);return t}}),busyCount=0;Object.defineProperty(app,"busy",{configurable:!0,enumerable:!0,get:()=>busyCount>0,set(e){let t=this.busy;if(t||e){busyCount+=e?1:-1;let r=this.busy;t!==r&&this.trigger("app:stateChange",r)}}});let worker=new Worker("js/rr-worker.js"),blockingMethod=null,workerHelper=Object.assign(new Observer,{invoke(e,t){if(blockingMethod)throw new Error(`Unable to run the method “${e}” as the blocking method “${blockingMethod}” is still running`);blockingMethod=e,app.busy=!0,worker.postMessage({method:e,data:t})}});worker.addEventListener("message",({data:{method:e,data:t}={}})=>{e&&(e===blockingMethod&&(app.busy=!1,blockingMethod=null),workerHelper.trigger(e,t))}),worker.addEventListener("error",e=>{throw e});let structure={name:"",atoms:[],bonds:[]},atomSet=new Set,pairSet=new Set,structureUtils=Object.assign(new Observer,{getPairList(e){switch(e){case"basic":return[...pairSet].filter(e=>!e.startsWith("x-"));case"extra":return[...pairSet].filter(e=>e.startsWith("x-"));default:return[...pairSet]}},getPairSet(e){return new Set(this.getPairList(e))},getAtomList:()=>[...atomSet],getAtomSet(){return new Set(this.getAtomList())},overwrite(e,t=!0){if(({name:structure.name="",atoms:structure.atoms=[],bonds:structure.bonds=[]}=e),!1!==t){atomSet=new Set(structure.atoms.map(e=>e.el));let e=this.getAtomList(),t=[];for(let[r,a]of e.entries())t.push(...e.slice(r).map(e=>a+e));t.push(...t.map(e=>`x-${e}`)),pairSet=new Set(t)}this.trigger("updateStructure",!1!==t)},getCentroid(){let e={x:0,y:0,z:0};for(let{x:t,y:r,z:a}of structure.atoms)e.x+=t,e.y+=r,e.z+=a;let t=structure.atoms.length;return e.x/=t,e.y/=t,e.z/=t,e},getWrappingSphere(){let{x:e,y:t,z:r}=this.getCentroid(),a=0;for(let{x:s,y:n,z:i}of structure.atoms){let o=(s-e)*(s-e)+(n-t)*(n-t)+(i-r)*(i-r);o>a&&(a=o)}return{cx:e,cy:t,cz:r,r:Math.sqrt(a)}},translate(e,t,r){let a=this.getCentroid(),s=e-a.x,n=t-a.y,i=r-a.z;for(let e of structure.atoms)e.x+=s,e.y+=n,e.z+=i;this.overwrite(structure,!1)},rotate(e,t){let r="x"===t?"y":"x",a="z"===t?"y":"z",s=Math.sin(e),n=Math.cos(e);for(let e of structure.atoms){let t=e[r],i=e[a];e[r]=t*n+i*s,e[a]=i*n-t*s}this.overwrite(structure,!1)}});function to$(e){return e&&e.jquery?e:$(e)}Object.defineProperty(structureUtils,"structure",{enumerable:!0,get:()=>structure}),workerHelper.on("updateStructure",e=>structureUtils.overwrite(e));class Eventful{constructor(e){this.$el=to$(e)}listen(e){for(let{type:t,owner:r,filter:a,handler:s}of e){let e="function"==typeof s?s:this[s];r instanceof Observer?r.on(t,e.bind(this)):to$(r||this.$el).on(t,a||null,e.bind(this))}}}let blobUrl,events=[{type:"click",filter:".nt-apply",handler(...e){this.handleApply(...e)}},{type:"click",filter:".nt-discard",handler(...e){this.handleDiscard(...e)}},{type:"keyup",owner:document,handler(...e){this.handleGlobalKeyUp(...e)}}];class AbstractDialog extends Eventful{constructor(e){super(e),this.listen(events)}handleApply(){this.apply(),this.hide()}handleDiscard(){this.discard(),this.hide()}handleGlobalKeyUp(e){27===e.which&&(this.discard(),this.hide())}apply(){}discard(){}show(){this.$el.removeClass("hidden")}hide(){this.$el.addClass("hidden")}fix(e){e||(e=this.$el[0].elements);for(let t of Array.from(e))"checkbox"===t.type||"radio"===t.type?t.defaultChecked=t.checked:"OPTION"===t.nodeName.toUpperCase()?t.defaultSelected=t.selected:"defaultValue"in t?t.defaultValue=t.value:t.options&&this.fix(t.options)}reset(){this.$el[0].reset()}}let utils={readFile:e=>new Promise((t,r)=>{if("string"==typeof e){let a=new XMLHttpRequest;a.open("GET",e,!0),a.addEventListener("load",()=>{200===a.status&&t(a.responseText)}),a.addEventListener("error",()=>r(a.status)),a.send(null)}else{let a=new FileReader;a.addEventListener("load",()=>t(a.result)),a.addEventListener("error",()=>r(a.error)),a.readAsText(e)}}),getBlobURL(e,t="text/plain"){let r=e instanceof Blob?e:new Blob([e],{type:t});return blobUrl&&URL.revokeObjectURL(blobUrl),blobUrl=URL.createObjectURL(r)}},formats={};formats.hin={parseMolecule(e,t,r){let{atoms:a,bonds:s}=r,n=a.length,i=/\s+/;for(let r=0,o=t.length;r<o;r++){let o=t[r].trim().split(i);a.push({el:o[3],x:+o[7],y:+o[8],z:+o[9],mol:e});for(let e=11,t=2*o[10]+11;e<t;e+=2)o[e]-1>r&&s.push({iAtm:r+n,jAtm:o[e]-1+n,type:o[e+1]})}},parse(e){let t=/\n\s*mol\s+(\d+)([\s\S]+)\n\s*endmol\s+\1\b/g,r=/^atom\s+\d+\s+.+$/gm,a={atoms:[],bonds:[]},s=t.exec(e);for(;s;)this.parseMolecule(s[1]-1,s[2].match(r),a),s=t.exec(e);return a},make(){let e=structureUtils.structure.atoms,t=[];for(let[r,{mol:a}]of e.entries()){let e=t[a]||(t[a]=[]);e[e.length]=r}let r=new Array(e.length);for(let{type:a,iAtm:s,jAtm:n}of structureUtils.structure.bonds){let i=t[e[s].mol].indexOf(s)+1,o=t[e[n].mol].indexOf(n)+1;(r[s]||(r[s]=[])).push(`${o} ${a}`),(r[n]||(r[n]=[])).push(`${i} ${a}`)}let a=";The structure was saved in Nanothrower\nforcefield mm+\n";for(let[s,n]of t.entries()){a+=`mol ${s+1}\n`;for(let[t,s]of n.entries()){let{el:n,x:i,y:o,z:l}=e[s],d=r[s];a+=`atom ${t+1} - ${n} ** - 0 ${i.toFixed(4)} ${o.toFixed(4)} ${l.toFixed(4)} `+(d?`${d.length} ${d.join(" ")}`:"0")+"\n"}a+=`endmol ${s+1}\n`}return a}},formats.ml2=formats.mol2={bondTypes:new Map([["s","1"],["d","2"],["t","3"],["a","ar"]]),parseMolecule(e,t,r,a){let{atoms:s,bonds:n}=a,i=s.length,o=/\s+/;for(let r of t){let t=r.trim().split(o),a=t[5].indexOf(".");s.push({el:a>-1?t[5].slice(0,a):t[5],x:+t[2],y:+t[3],z:+t[4],mol:e})}for(let e of r){let t=e.trim().split(o),r=[...this.bondTypes].find(e=>e[1]===t[3]);n.push({iAtm:t[1]-1+i,jAtm:t[2]-1+i,type:r&&r[0]||"s"})}},parse(e){let t={atoms:[],bonds:[]},r=e.split("@<TRIPOS>MOLECULE").slice(1),a=/@<TRIPOS>ATOM([\s\S]+?)(?:@<TRIPOS>|$)/,s=/@<TRIPOS>BOND([\s\S]+?)(?:@<TRIPOS>|$)/,n=/(?:\r?\n)+/,i=[];for(let[e,o]of r.entries()){let r=o.match(a),l=r&&r[1].trim().split(n)||i,d=o.match(s),h=d&&d[1].trim().split(n)||i;this.parseMolecule(e,l,h,t)}return t},make(){let e=structureUtils.structure.atoms,t=[];for(let[r,{mol:a}]of e.entries()){let e=t[a]||(t[a]=[]);e[e.length]=r}let r={};for(let{type:a,iAtm:s,jAtm:n}of structureUtils.structure.bonds){let i=t[e[s].mol].indexOf(s)+1,o=t[e[n].mol].indexOf(n)+1;(r[s]||(r[s]=[])).push(`${i} ${o} ${this.bondTypes.get(a)||1}`)}let a="# The structure was saved in Nanothrower\n";for(let s of t){a+=`@<TRIPOS>MOLECULE\n****\n${s.length} %BOND_COUNT%\nSMALL\nNO_CHARGES\n\n\n@<TRIPOS>ATOM\n`;let t=[];for(let[n,i]of s.entries()){let{el:s,x:o,y:l,z:d}=e[i];a+=`${n+1} ${s} ${o.toFixed(4)} ${l.toFixed(4)} ${d.toFixed(4)} ${s} 1 **** 0.0000\n`,r[i]&&t.push(...r[i])}a=a.replace("%BOND_COUNT%",t.length.toString()),a+="@<TRIPOS>BOND\n";for(let[e,r]of t.entries())a+=`${e+1} ${r}\n`;a+="@<TRIPOS>SUBSTRUCTURE\n1 **** 0\n"}return a}},formats.xyz={parseAtomRecord(e){let t=e.trim().split(/\s+/);return{el:t[0],x:+t[1],y:+t[2],z:+t[3]}},parse(e){let t=e.split(/(?:\r?\n)+/).slice(2);return t&&{atoms:t.map(this.parseAtomRecord,this),bonds:[]}},make(){let e=structureUtils.structure.atoms.length+"\nThe structure was saved in Nanothrower";for(let{el:t,x:r,y:a,z:s}of structureUtils.structure.atoms)e+=`\n${t} ${r.toFixed(5)} ${a.toFixed(5)} ${s.toFixed(5)}`;return e}},formats.json={parse:e=>JSON.parse(e),make:()=>JSON.stringify(structureUtils.structure,null,2)};var fileAPI={load:e=>utils.readFile(e).then(t=>{let r=e.name||String(e),a=r.slice(r.lastIndexOf(".")+1).toLowerCase(),s=(formats[a]||formats.hin).parse(t);return s.name=r.replace(/.*[/\\]/,"")||"unknown",structureUtils.overwrite(s),t}),makeFile(e){let t=formats[e.toLowerCase()];return!!t&&t.make()}};let save=Object.assign(new AbstractDialog(".nt-save-form"),{handleSave(e){let t=$("#nt-file-type").val(),r=fileAPI.makeFile(t);r&&(e.target.setAttribute("download",`untitled.${t}`),e.target.href=utils.getBlobURL(r))}});save.listen([{type:"click",filter:".nt-apply",handler:"handleSave"}]),app.addAction("save",{get enabled(){return structureUtils.structure.atoms.length>0},exec(){save.show()}});let graphene={create(e){return{name:"Graphene",atoms:this.makeAtoms(e),bonds:this.makeBonds(e)}},makeAtoms({width:e,height:t,rCC:r}){let a=2*Math.round(e/(Math.sqrt(3)*r)),s=Math.round(2*t/(3*r)),n=(a+1)*s,i=r/2,o=Math.sqrt(3)*i,l=3*i,d=new Array(n),h=0;for(let e=0;e<s;e++){let t=e%2;for(let r=0;r<=a;r++,h++)d[h]={el:"C",x:o*r,y:e*l+(r%2===t?i:0),z:0,mol:0}}return d},makeBonds({width:e,height:t,rCC:r}){let a=2*Math.round(e/(Math.sqrt(3)*r))+1,s=a*Math.round(2*t/(3*r)),n=[];for(let e=0;e<s-1;e++)if((e+1)%a&&n.push({iAtm:e,jAtm:e+1,type:"a"}),e%2==0){let t=e+a;t<s&&n.push({iAtm:e,jAtm:t,type:"a"})}return n}};var makeGraphene=graphene.create.bind(graphene);let graphene$1=Object.assign(new AbstractDialog(".nt-graphene-form"),{handleApply(...e){if(this.$el[0].checkValidity())return Object.getPrototypeOf(this).handleApply.apply(this,e);window.alert("Please, fix invalid input first")},apply(){this.fix(),structureUtils.overwrite(makeGraphene({width:Number($("#graphene-width").val()),height:Number($("#graphene-height").val()),rCC:Number($("#graphene-rcc").val())})),structureUtils.translate(0,0,0)}});app.addAction("graphene",{get enabled(){return!0},exec(){graphene$1.show()}});let nanotube={create(e){return{name:"Nanotube",atoms:this.makeAtoms(e),bonds:this.makeBonds(e)}},makeAtoms({radius:e,length:t,rCC:r}){let a=r/e,s=Math.round(2*Math.PI/Math.acos(1-1.5*a*a));e=.5*Math.sqrt(3)*r/Math.sin(Math.PI/s);let n=2*Math.PI/s;a=e*(1-Math.cos(n/2));let i=Math.sqrt(r*r/4-a*a),o=Math.round(t/(r+i)),l=n/2,d=new Array(2*s*o),h=0;for(let t=0;t<o;t++){let a=t%2;for(let n=0;n<2*s;n++,h++)d[h]={el:"C",x:e*Math.cos(l*n),y:e*Math.sin(l*n),z:t*(r+i)+(n%2^a)*i,mol:0}}return d},makeBonds({radius:e,length:t,rCC:r}){let a=r/e,s=Math.round(2*Math.PI/Math.acos(1-1.5*a*a));e=.5*Math.sqrt(3)*r/Math.sin(Math.PI/s);let n=2*Math.PI/s;a=e*(1-Math.cos(n/2));let i=Math.sqrt(r*r/4-a*a),o=2*s,l=o*Math.round(t/(r+i)),d=[];for(let e=0;e<l;e++){if((e+1)%o?d.push({iAtm:e,jAtm:e+1,type:"a"}):d.push({iAtm:e,jAtm:e+1-o,type:"a"}),Math.trunc(e/o)%2^e%2){let t=e+o;t<l&&d.push({iAtm:e,jAtm:t,type:"a"})}}return d}};var makeNanotube=nanotube.create.bind(nanotube);let nanotube$1=Object.assign(new AbstractDialog(".nt-nanotube-form"),{handleApply(...e){if(this.$el[0].checkValidity())return Object.getPrototypeOf(this).handleApply.apply(this,e);window.alert("Please, fix invalid input first")},apply(){this.fix(),structureUtils.overwrite(makeNanotube({radius:Number($("#nanotube-radius").val()),length:Number($("#nanotube-length").val()),rCC:Number($("#graphene-rcc").val())})),structureUtils.translate(0,0,0)}});app.addAction("nanotube",{get enabled(){return!0},exec(){nanotube$1.show()}});let cacheRegistry=new WeakMap;class Cacheable{constructor(e){Object.defineProperty(this,"create",{configurable:!0,value:e}),cacheRegistry.set(this,new Map)}get(e){let t=cacheRegistry.get(this);return t.has(e)||t.set(e,this.create(e)),t.get(e)}renew(e){cacheRegistry.get(this).delete(e)}}let colors=new Cacheable(e=>new Color(e)),presets=Object.create({get(e){return this.hasOwnProperty(e)?this[e]:this._def},set(e,t){this.hasOwnProperty(e)?Object.assign(this[e],t):this[e]=Object.assign({},this._def,t)}},{_def:{value:Object.freeze({color:16777215,radius:1})}});presets.set("C",{color:16711680}),presets.set("H",{radius:.7}),presets.set("B",{color:16776960}),presets.set("N",{color:255});let canvas,assets3,pointMaterials=new Cacheable(e=>{let t=presets.get(e);return new PointsMaterial({color:t.color,sizeAttenuation:!1})}),atomMaterials=new Cacheable(e=>{let t=presets.get(e);return new MeshLambertMaterial({color:t.color})}),atomGeometries=new Cacheable(e=>{let t=presets.get(e);return new SphereGeometry(t.radius)}),bondMaterials=new Cacheable(e=>"extra"===e?new LineDashedMaterial({dashSize:.2,gapSize:.1,vertexColors:VertexColors}):new LineBasicMaterial({vertexColors:VertexColors})),rotation=0,draw={setup(e){canvas={el:e,width:e.offsetWidth,height:e.offsetHeight},(assets3={scene:new Scene,group:new Object3D,camera:new PerspectiveCamera(75,canvas.width/canvas.height,.1,1e3),spotLight:new SpotLight(16777215),renderer:new WebGLRenderer({canvas:e})}).spotLight.position.set(-40,60,50),assets3.scene.add(assets3.group,assets3.spotLight),assets3.camera.position.x=0,assets3.camera.position.y=0,assets3.camera.position.z=20,assets3.camera.lookAt(assets3.scene.position),assets3.renderer.setClearColor(0),assets3.renderer.setSize(canvas.width,canvas.height),assets3.renderer.render(assets3.scene,assets3.camera)},get canvas(){return canvas.el},get rotation(){return rotation},set rotation(e){e!==rotation&&Number.isFinite(e)&&(rotation=e,assets3.group.rotation.y+=.05*(rotation-assets3.group.rotation.y))},appearance:"graph",zoom(e){assets3.camera.position.z+=e,assets3.camera.lookAt(assets3.scene.position),this.update()},resize(e=canvas.el.offsetWidth,t=canvas.el.offsetHeight){e>0&&t>0&&(e!==canvas.width||t!==canvas.height)&&(assets3.camera.aspect=e/t,assets3.camera.updateProjectionMatrix(),assets3.renderer.setSize(e,t,!1),canvas.width=e,canvas.height=t,this.update())},render(){this.resetScene(),this.update()},update(){assets3.renderer.render(assets3.scene,assets3.camera),this.autoUpdate&&requestAnimationFrame(()=>this.update())},getAtomColor:e=>presets.get(e).color,setAtomColors(e){for(let[t,r]of e)this.getAtomColor(t)!==r&&(presets.set(t,{color:r}),atomMaterials.renew(t),pointMaterials.renew(t))},setBgColor(e){"string"==typeof e&&(e=Number(e.replace("#","0x"))),assets3.renderer.setClearColor(e)},clearScene(){let e=assets3.group,t=e.children[0];for(;t;)e.remove(t),t=e.children[0]},resetScene(){this.clearScene(),"spheres"===this.appearance?this.addSceneAtoms():structureUtils.structure.bonds.length?this.addSceneBonds():this.addScenePoints()},addSceneAtoms(){let e=Mesh,t=assets3.group;for(let{el:r,x:a,y:s,z:n}of structureUtils.structure.atoms){let i=new e(atomGeometries.get(r),atomMaterials.get(r));i.position.x=a,i.position.y=s,i.position.z=n,t.add(i)}},addSceneBonds(){let e=Line,t=Vector3,r=assets3.group,a=structureUtils.structure.atoms,s=new Int8Array(a.length);for(let{type:n,iAtm:i,jAtm:o}of structureUtils.structure.bonds){s[i]=s[o]=1;let l=new Geometry,d=a[i];l.vertices.push(new t(d.x,d.y,d.z)),l.colors.push(colors.get(presets.get(d.el).color)),d=a[o],l.vertices.push(new t(d.x,d.y,d.z)),l.colors.push(colors.get(presets.get(d.el).color)),"x"===n?(l.computeLineDistances(),r.add(new e(l,bondMaterials.get("extra"),LineStrip))):r.add(new e(l,bondMaterials.get("basic")))}let n=Points,i=s.indexOf(0);for(;-1!==i;){let e=new Geometry,o=a[i];e.vertices.push(new t(o.x,o.y,o.z)),r.add(new n(e,pointMaterials.get(o.el))),i=s.indexOf(0,i+1)}},addScenePoints(){let e=Points,t=Vector3,r=assets3.group;for(let{el:a,x:s,y:n,z:i}of structureUtils.structure.atoms){let o=new Geometry;o.vertices.push(new t(s,n,i)),r.add(new e(o,pointMaterials.get(a)))}},addAxes(){this.axes||(this.axes=new AxisHelper(20),assets3.scene.add(this.axes),this.update())},removeAxes(){this.axes&&(assets3.scene.remove(this.axes),this.axes=void 0,this.update())},addWireSphere({cx:e,cy:t,cz:r,r:a,color:s=16777215}){let n=this.wireSphere;n||((n=this.wireSphere=new Mesh(new SphereGeometry(a,15,15),new MeshBasicMaterial({color:s,wireframe:!0}))).position.x=e,n.position.y=t,n.position.z=r,assets3.scene.add(n),this.update())},removeWireSphere(){this.wireSphere&&(assets3.scene.remove(this.wireSphere),this.wireSphere=void 0,this.update())}};structureUtils.on("updateStructure",draw.render.bind(draw));let transform=Object.assign(new AbstractDialog(".nt-transform-form"),{handleAppStateChange(e){this.$el.find("fieldset").prop("disabled",e)},handleTranslate(){let e=this.$el.find(".nt-translate"),t=+e.find("[data-axis='x']").val(),r=+e.find("[data-axis='y']").val(),a=+e.find("[data-axis='z']").val();structureUtils.translate(t,r,a)},handleRotate(e){let t=$("#nt-rotate-angle").val()*Math.PI/180,r=e.target.getAttribute("data-axis");structureUtils.rotate(t,r)},show(...e){let t=structureUtils.getCentroid(),r=this.$el.find(".nt-translate input[data-axis]");return r.val(e=>t[r.eq(e).data("axis")].toFixed(5)),draw.addAxes(),Object.getPrototypeOf(this).show.apply(this,e)},hide(...e){return draw.removeAxes(),Object.getPrototypeOf(this).hide.apply(this,e)}});transform.listen([{type:"app:stateChange",owner:app,handler:"handleAppStateChange"},{type:"click",owner:"#nt-translate-apply",handler:"handleTranslate"},{type:"click",filter:".nt-rotate [data-axis]",handler:"handleRotate"}]),app.addAction("transform",{get enabled(){return structureUtils.structure.atoms.length>0},exec(){transform.show()}});let bnConvert={convert(){let e=JSON.parse(JSON.stringify(structureUtils.structure.atoms));for(let{iAtm:t,jAtm:r}of structureUtils.structure.bonds){let a=e[t].el,s=e[r].el;"C"===a&&"C"===s?(e[t].el="B",e[r].el="N"):"C"===a?e[t].el="B"===s?"N":"B":"C"===s&&(e[r].el="B"===a?"N":"B")}structureUtils.overwrite(Object.assign({},structureUtils.structure,{atoms:e}))}};app.addAction("bnConvert",{get enabled(){return structureUtils.structure.atoms.length>0},exec(){bnConvert.convert()}});let atomicMasses={H:1.00794,H1:1.00794,He:4.002602,Li:6.941,Be:9.01218,B:10.811,C:12.011,N:14.0067,O:15.9994,F:18.998403,Ne:20.179,Na:22.98977,Mg:24.305,Al:26.98154,Si:28.0855,P:30.97376,S:32.066,Cl:35.453,Ar:39.948,K:39.0983,Ca:40.078,Sc:44.95591,Ti:47.88,V:50.9415,Cr:51.9961,Mn:54.938,Fe:55.847,Co:58.9332,Ni:58.69,Cu:63.546,Zn:65.39,Ga:69.723,Ge:72.59,As:74.9216,Se:78.96,Br:79.904,Kr:83.8,Rb:85.4678,Sr:87.62,Y:88.9059,Zr:91.224,Nb:92.9064,Mo:95.94,Tc:97.9072,Ru:101.07,Rh:102.9055,Pd:106.42,Ag:107.8682,Cd:112.41,In:114.82,Sn:118.71,Sb:121.75,Te:127.6,I:126.9045,Xe:131.29,Cs:132.9054,Ba:137.33,La:138.9055,Ce:140.12,Pr:140.9077,Nd:144.24,Pm:144.9128,Sm:150.36,Eu:151.96,Gd:157.25,Tb:158.9254,Dy:162.5,Ho:164.9304,Er:167.26,Tm:168.9342,Yb:173.04,Lu:174.967,Hf:178.49,Ta:180.9479,W:183.85,Re:186.207,Os:190.2,Ir:192.22,Pt:195.08,Au:196.9665,Hg:200.59,Tl:204.383,Pb:207.2,Bi:208.9804,Po:208.9824,At:209.9871,Rn:222.0176,Fr:223.0197,Ra:226.0254,Ac:227.0278,Th:232.0381,Pa:231.0359,U:238.0289,Np:237.0482,Pu:244.0642,Am:243.0614,Cm:247.0703,Bk:247.0703,Cf:251.0796,Es:252.0828,Fm:257.0951,Md:258.0986,No:259.1009,Lr:260.1054,Rf:261,Db:262,Sg:263,Bh:262,Hs:265,Mt:266};var chem={getAtomicMass:e=>atomicMasses[e],countAtoms(e,t="H"){let r=0,a=`${t}1`;for(let{el:s}of e)s!==t&&s!==a||r++;return r},getConcentration(e,t="H"){let r=0,a=0,s=`${t}1`;for(let{el:n}of e){let e=atomicMasses[n];r+=e,n!==t&&n!==s||(a+=e)}return a/r},conToNum(e,t,r="H"){let a=0,s=`${r}1`;for(let{el:t}of e)t!==r&&t!==s&&(a+=atomicMasses[t]);return Math.round(t*a/((1-t)*atomicMasses[r]))}};let rndRain=Object.assign(new AbstractDialog(".nt-rnd-rain-form"),{show(...e){let t=this.sphere=structureUtils.getWrappingSphere();return t.r*=1.1,draw.addWireSphere(t),$("#nt-sphere-radius").val(t.r.toFixed(3)),Object.getPrototypeOf(this).show.apply(this,e)},hide(...e){return draw.removeWireSphere(),Object.getPrototypeOf(this).hide.apply(this,e)},handleApply(...e){if(this.$el[0].checkValidity())return Object.getPrototypeOf(this).handleApply.apply(this,e);window.alert("Please, fix invalid input first")},apply(){this.fix();let e=Number($("#nt-adsorb-concentration").val()),t=chem.conToNum(structureUtils.structure.atoms,e),r=chem.countAtoms(structureUtils.structure.atoms);if(t<=r)return void window.alert("The given mass concentration of hydrogen is already reached");let a=$("#nt-distance-fields").find("label[data-el]").get(),s=new Map(a.map(e=>[$(e).data("el"),Number($("input",e).val())]));s.set("H1",s.get("H")),workerHelper.invoke("run",{mode:this.$el.find("input[name='nt-src-mode']").filter(":checked").val(),molecular:$("#nt-adsorb-mol").prop("checked"),biradical:$("#nt-adsorb-birad").prop("checked"),rHH:Number($("#nt-adsorb-r-hh").val()),hCount:t-r,sphere:this.sphere,structure:structureUtils.structure,captureDistances:s})},discard(){this.reset()},resetHTML(){let e=structureUtils.getAtomSet();e.add("H");let t="";for(let r of e)t+=`<label data-el="${r}"><input type="text" pattern="\\d*\\.?\\d+([eE][+-]?\\d+)?" required></label>`;$("#nt-distance-fields").html(t)},handleMolecularChange(e){let t=e.target.checked;$("#nt-adsorb-birad").prop({checked:t,disabled:!t}),$("#nt-adsorb-r-hh").prop({required:t,disabled:!t})},handleRadiusChange(e){e.target.checkValidity()&&(this.sphere.r=Number(e.target.value),draw.removeWireSphere(),draw.addWireSphere(this.sphere))},updateProgress(e){app.trigger("app:progress",e)},updateStructure(e){structureUtils.overwrite(e)}});rndRain.listen([{type:"change",owner:"#nt-adsorb-mol",handler:"handleMolecularChange"},{type:"change",owner:"#nt-sphere-radius",handler:"handleRadiusChange"},{type:"app:structure:loaded",owner:app,handler:"resetHTML"},{type:"updateStructure",owner:structureUtils,handler:"resetHTML"},{type:"progress",owner:workerHelper,handler:"updateProgress"},{type:"run",owner:workerHelper,handler:"updateStructure"}]),app.addAction("rndRain",{get enabled(){return structureUtils.structure.atoms.length>0},exec(){rndRain.show()}});let disabled,appearance=Object.assign(new AbstractDialog(".nt-appearance-form"),{handleUpdateStructure(e){e&&($("#nt-appearance-element").html("<option selected>"+structureUtils.getAtomList().join("</option><option>")+"</option>"),this.setCurrElementColor())},handleColorChange(e){let t=parseInt(e.target.value.slice(1),16);isNaN(t)||(this.tmpClrPresets||(this.tmpClrPresets=new Map),this.tmpClrPresets.set($("#nt-appearance-element").val(),t))},apply(){draw.appearance=this.$el.find("input[name='appearance']:checked").data("appearance"),draw.setBgColor($("#nt-bg-color").val()),this.tmpClrPresets&&(draw.setAtomColors(this.tmpClrPresets),this.tmpClrPresets=void 0),draw.render(),this.fix()},discard(){this.reset(),this.tmpClrPresets=void 0,this.setCurrElementColor()},setCurrElementColor(){let e,t=$("#nt-appearance-element").val();e=this.tmpClrPresets&&this.tmpClrPresets.has(t)?this.tmpClrPresets.get(t):draw.getAtomColor(t),$("#nt-appearance-color").val("#"+e.toString(16).padStart(6,"0"))}});appearance.listen([{type:"updateStructure",owner:structureUtils,handler:"handleUpdateStructure"},{type:"change",owner:"#nt-appearance-element",handler:"setCurrElementColor"},{type:"change",owner:"#nt-appearance-color",handler:"handleColorChange"}]),app.addAction("alterView",{get enabled(){return structureUtils.structure.atoms.length>0},exec(){appearance.show()}});let menu=Object.assign(new Eventful(".nt-menu"),{handleAppStateChange(e){this.disabled=e},handleGlobalClick(e){if(this.disabled)return;let t=$(e.target),r=this.$el.find("menu.expanded");if(t.is(".nt-menu button[menu]")){let e=$("#"+t.attr("menu")).toggleClass("expanded");e.hasClass("expanded")&&this.setItemStates(),r=r.not(e)}r.removeClass("expanded")},handleHover(e){if(this.disabled)return;let t=this.$el.find("menu.expanded");if(t.length){let r=$(e.target).siblings("menu");t.is(r)||(t.removeClass("expanded"),r.addClass("expanded"))}},handleAction(e){let t=$(e.target).data("action");"load"===t?$("#nt-file").trigger("click"):app.execAction(t)},handleFile(e){app.execAction("load",e.target.files[0])},setItemStates(e){let t=this.$el.find("menuitem[data-action]");e&&(t=t.filter(`[data-action="${e}"]`));let r=app.getActionStates();t.each((e,t)=>{let a=r.get(t.getAttribute("data-action")),s=t.hasAttribute("disabled");a&&s?t.removeAttribute("disabled"):a||s||t.setAttribute("disabled","disabled")})}});Object.defineProperty(menu,"disabled",{enumerable:!0,get:()=>disabled,set(e){disabled=!!e,this.$el.toggleClass("nt-disabled",!!disabled),disabled&&this.$el.find("menu.expanded").removeClass("expanded")}}),menu.listen([{type:"app:stateChange",owner:app,handler:"handleAppStateChange"},{type:"click",owner:document,handler:"handleGlobalClick"},{type:"mouseenter",owner:".nt-menu",filter:"button[menu]",handler:"handleHover"},{type:"click",owner:".nt-menu",filter:"menuitem[data-action]",handler:"handleAction"},{type:"change",owner:"#nt-file",handler:"handleFile"}]),menu.disabled=app.busy,app.addAction("load",{get enabled(){return!0},exec(e){e&&fileAPI.load(e).then(()=>app.trigger("app:structure:loaded"))}});let view=Object.assign(new Eventful("#nt-view"),{rotData:{startX:0,startRot:0},handleDragEnterOver(e){e.preventDefault(),"dragenter"===e.type&&e.currentTarget.classList.add("nt-droppable")},handleDragLeave(e){e.preventDefault(),e.target===e.currentTarget&&e.target.classList.remove("nt-droppable")},handleDrop(e){let t=e.originalEvent.dataTransfer,r=t&&t.files;r&&r.length&&(e.preventDefault(),app.execAction("load",r[0])),e.currentTarget.classList.remove("nt-droppable")},handleWheelZoom(e){draw.zoom(e.originalEvent.deltaY<0?5:-5),e.preventDefault()},handleStartRotate(e){this.rotData.startX=e.pageX,this.rotData.startRot=draw.rotation,this.$el.on("mouseup.ntViewRotation mouseleave.ntViewRotation",this.handleStopRotate.bind(this)).on("mousemove.ntViewRotation",this.handleRotate.bind(this)),draw.autoUpdate=!0,draw.update()},handleStopRotate(){draw.autoUpdate=!1,this.$el.off(".ntViewRotation")},handleRotate(e){draw.rotation=this.rotData.startRot+.02*(e.pageX-this.rotData.startX)},handleWndResize(){this._resizeTimer||(this._resizeTimer=setTimeout(()=>{draw.resize(),this._resizeTimer=void 0},300))},handleDblClick(){let e=structureUtils.getWrappingSphere();draw.addWireSphere(e.cx,e.cy,e.cz,e.r)}});view.listen([{type:"dragenter dragover",handler:"handleDragEnterOver"},{type:"dragleave",handler:"handleDragLeave"},{type:"drop",handler:"handleDrop"},{type:"wheel",handler:"handleWheelZoom"},{type:"mousedown",handler:"handleStartRotate"},{type:"resize",owner:window,handler:"handleWndResize"},{type:"dblclick",handler:"handleDblClick"}]),draw.setup(view.$el.children("canvas")[0]),app.on("app:structure:loaded",()=>{document.title=`${structureUtils.structure.name} - Nanothrower`}),app.on("app:stateChange",e=>{document.body.classList.toggle("app-busy",e),e||(document.getElementById("nt-progress").innerHTML="")}),app.on("app:progress",e=>{document.getElementById("nt-progress").innerHTML=Math.round(e)+"%"});
